<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EGFR Structures (cartoon + ligand)</title>
  <script src="https://3dmol.org/build/3Dmol-min.js"></script>
  <style>
    :root { --card-h: 420px; --gap: 14px; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f4f6f8; color:#222; }
    header { background:#f18700; color:#fff; padding:10px 16px; font-weight:700; }
    .grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      padding: var(--gap);
      max-width: 1400px;
      margin: 0 auto;
    }
    .card {
      background:#fff;
      border-radius:12px;
      box-shadow: 0 3px 14px rgba(0,0,0,.08);
      border:1px solid #e6e9ee;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: calc(var(--card-h) + 44px);
    }
    .card h3 {
      margin:0; padding:10px 12px; font-size:14px; font-weight:700; color:#111;
      border-bottom:1px solid #eef1f5; background:#fafbfc;
    }
    .viewer-wrap { position:relative; height: var(--card-h); width: 100%; overflow:hidden; background:#fff; }
    .viewer { position:absolute; inset:0; width:100%; height:100%; }
    .foot { padding:8px 12px; font-size:12px; color:#6b7280; border-top:1px solid #eef1f5; }
    .error {
      position:absolute; inset:auto 12px 12px 12px;
      background:#fff2f2; color:#b00020; border:1px solid #f3c2c2;
      padding:8px 10px; border-radius:8px; font-size:12px; line-height:1.3;
    }
    @media (max-width: 900px){
      .grid { grid-template-columns: 1fr; }
      :root { --card-h: 380px; }
    }
  </style>
</head>
<body>
  <header>EGFR Structures (interactive) — drag to rotate, scroll to zoom</header>

  <div class="grid">
    <div class="card">
      <h3>EGFR + Erlotinib (T790W)</h3>
      <div class="viewer-wrap"><div id="v1" class="viewer"></div></div>
      <div class="foot">Cartoon protein + ligand sticks; highlights residue 790</div>
    </div>
    <div class="card">
      <h3>EGFR + Erlotinib (WT)</h3>
      <div class="viewer-wrap"><div id="v2" class="viewer"></div></div>
      <div class="foot">Cartoon protein + ligand sticks; highlights residue 790</div>
    </div>
    <div class="card">
      <h3>EGFR + Osimertinib (C797F)</h3>
      <div class="viewer-wrap"><div id="v3" class="viewer"></div></div>
      <div class="foot">Cartoon protein + ligand sticks; highlights residue 797</div>
    </div>
    <div class="card">
      <h3>EGFR + Osimertinib (WT)</h3>
      <div class="viewer-wrap"><div id="v4" class="viewer"></div></div>
      <div class="foot">Cartoon protein + ligand sticks; highlights residue 797</div>
    </div>
  </div>

  <script>
    // If the PDBs sit next to this HTML, keep ''. If they're in a subfolder, set e.g. 'structures/'.
    const LOCAL_BASE = '';

    // Raw fallback (different origin) if a file isn’t on Pages yet
    const RAW_BASE = "https://raw.githubusercontent.com/Mohammed-Balkhair-hub/Boltz-2_-Benchmark/refs/heads/main/";

    const FILES = [
      { div: 'v1', name: 'EGFR_erlotinib_T790W_trimmed.pdb', highlightResi: 790 },
      { div: 'v2', name: 'EGFR_erlotinib_trimmed.pdb',        highlightResi: 790 },
      { div: 'v3', name: 'EGFR_osimertinib_C797F_trimmed.pdb',highlightResi: 797 },
      { div: 'v4', name: 'EGFR_osimertinib_trimmed.pdb',      highlightResi: 797 }
    ];

    function showError(divId, msg) {
      const wrap = document.getElementById(divId).parentElement;
      const box = document.createElement('div');
      box.className = 'error';
      box.innerHTML = `⚠️ ${msg}`;
      wrap.appendChild(box);
    }

    async function fetchPDB(url) {
      const r = await fetch(url, { cache: 'no-store' });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText} — ${url}`);
      return await r.text();
    }

    function highlightResidue(viewer, resi) {
      // Find the residue (first match among non-het atoms)
      const atoms = viewer.getModel().selectedAtoms({ hetflag: false, resi });
      if (!atoms || atoms.length === 0) return;

      const resn = atoms[0].resn || '';
      const chain = atoms[0].chain || undefined;

      // Show that residue as thick yellow sticks
      viewer.setStyle({ hetflag: false, resi, chain }, { stick: { radius: 0.35, color: 'yellow' } });

      // Add a label (e.g., "CYS 797")
      const labelText = `${resn} ${resi}`;
      // Place label near residue centroid
      let cx = 0, cy = 0, cz = 0;
      atoms.forEach(a => { cx += a.x; cy += a.y; cz += a.z; });
      cx /= atoms.length; cy /= atoms.length; cz /= atoms.length;

      viewer.addLabel(labelText, {
        position: { x: cx, y: cy, z: cz },
        backgroundColor: "rgba(0,0,0,0.65)",
        backgroundOpacity: 0.65,
        fontColor: "white",
        fontSize: 14,
        borderThickness: 0.0,
        alignment: "center"
      });
    }

    async function loadViewer(divId, pdbName, highlightResi) {
      const el = document.getElementById(divId);
      const viewer = $3Dmol.createViewer(el, { backgroundColor: '#101214' }); // dark to pop colors

      // try same-origin first
      let pdbText = null;
      try { pdbText = await fetchPDB(`${LOCAL_BASE}${pdbName}`); }
      catch (e1) {
        console.warn('Local fetch failed:', e1.message);
        try { pdbText = await fetchPDB(`${RAW_BASE}${pdbName}`); }
        catch (e2) {
          console.error('Raw fetch failed:', e2.message);
          showError(divId, `Couldn’t load <b>${pdbName}</b><br><code>${e2.message}</code>`);
          return;
        }
      }

      try {
        viewer.addModel(pdbText, 'pdb');

        // Cartoon for protein; fall back to tube if no secondary structure
        viewer.setStyle({ hetflag: false }, { cartoon: { color: 'spectrum' } });
        const protAtoms = viewer.getModel().selectedAtoms({ hetflag: false });
        if (!protAtoms || protAtoms.length === 0) {
          viewer.setStyle({ atom: 'CA' }, { tube: { radius: 0.35, color: 'spectrum' } });
        }

        // Sticks for ligand / hetero atoms
        viewer.setStyle({ hetflag: true }, { stick: { radius: 0.22 } });

        // Highlight requested residue (797 or 790)
        if (highlightResi) highlightResidue(viewer, highlightResi);

        // Nice view: prefer ligand centroid; else whole protein
        const lig = viewer.getModel().selectedAtoms({ hetflag: true });
        if (lig && lig.length) viewer.zoomTo({ hetflag: true }); else viewer.zoomTo();

        viewer.render();
        // keep canvas sized to its card
        const onResize = () => viewer.resize();
        window.addEventListener('resize', onResize, { passive: true });
      } catch (e) {
        console.error('Viewer error:', e);
        showError(divId, `Rendering error for <b>${pdbName}</b><br><code>${e.message}</code>`);
      }
    }

    // Load all four panels
    FILES.forEach(x => loadViewer(x.div, x.name, x.highlightResi));
  </script>
</body>
</html>
