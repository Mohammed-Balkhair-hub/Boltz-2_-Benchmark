<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EGFR WT → Mutant Transitions (Erlotinib & Osimertinib)</title>
<script src="https://3dmol.org/build/3Dmol-min.js"></script>
<style>
  :root{--h:440px;--gap:14px}
  *{box-sizing:border-box}
  body{margin:0;background:#0b1020;color:#eaf2ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  header{padding:14px 16px;background:linear-gradient(90deg,#203773,#5aa3ff);font-weight:800}
  header .sub{opacity:.8;font-weight:500;font-size:13px}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:var(--gap);grid-template-columns:1fr}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:linear-gradient(180deg,#121a33,#0f1530);border:1px solid rgba(138,162,255,.22);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
  .head{padding:12px 14px;border-bottom:1px solid rgba(138,162,255,.22);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .title{font-weight:750}
  .meta{opacity:.8;font-size:12.5px}
  .viewerWrap{position:relative;height:var(--h);background:#0a0e1f}
  .viewer{position:absolute;inset:0}
  .hud{position:absolute;left:10px;bottom:10px;display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid rgba(138,162,255,.35);background:rgba(90,163,255,.12);padding:8px 10px;border-radius:10px;color:#eaf2ff;font-weight:650;font-size:12.5px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .badge{border:1px solid rgba(138,162,255,.35);background:rgba(139,92,246,.18);padding:6px 10px;border-radius:999px;font-size:12px}
  .label{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.55);padding:6px 10px;border-radius:8px;font-size:12.5px}
  .note{padding:10px 14px;border-top:1px solid rgba(138,162,255,.22);font-size:12.5px;opacity:.85}
</style>
</head>
<body>
<header>
  <div>EGFR Transition Animations — WT → Mutant</div>
  <div class="sub">Crossfade morphs of protein + ligand; mutation residue label flips at the end. You can also record to WebM.</div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Pair 1: Erlotinib (WT vs T790W) -->
    <section class="card" id="pair1">
      <div class="head">
        <div>
          <div class="title">Erlotinib — WT → T790W</div>
          <div class="meta">Highlights residue 790; ligand sticks; protein cartoon</div>
        </div>
        <div class="badge" id="b1">Residue: <span class="reslbl">THR 790</span> → <span class="mutlbl">TRP 790</span></div>
      </div>
      <div class="viewerWrap">
        <div id="v1" class="viewer"></div>
        <div class="label" id="l1">THR 790</div>
        <div class="hud">
          <button class="btn" id="p1Play">▶ Play transition</button>
          <button class="btn" id="p1Reset">↺ Reset</button>
          <button class="btn" id="p1Rec">⏺ Record (5s)</button>
        </div>
      </div>
      <div class="note">Tip: Click and drag to rotate. The animation crossfades between WT and mutant models that are loaded and aligned in place.</div>
    </section>

    <!-- Pair 2: Osimertinib (WT vs C797F) -->
    <section class="card" id="pair2">
      <div class="head">
        <div>
          <div class="title">Osimertinib — WT → C797F</div>
          <div class="meta">Highlights residue 797; ligand sticks; protein cartoon</div>
        </div>
        <div class="badge" id="b2">Residue: <span class="reslbl">CYS 797</span> → <span class="mutlbl">PHE 797</span></div>
      </div>
      <div class="viewerWrap">
        <div id="v2" class="viewer"></div>
        <div class="label" id="l2">CYS 797</div>
        <div class="hud">
          <button class="btn" id="p2Play">▶ Play transition</button>
          <button class="btn" id="p2Reset">↺ Reset</button>
          <button class="btn" id="p2Rec">⏺ Record (5s)</button>
        </div>
      </div>
      <div class="note">Recording captures the canvas to a WebM file using your browser’s MediaRecorder API.</div>
    </section>

  </div>
</div>

<script>
  // ---- File locations ----
  const LOCAL_BASE = ''; // if PDBs are in the same repo/folder as this HTML
  const RAW_BASE   = 'https://raw.githubusercontent.com/Mohammed-Balkhair-hub/Boltz-2_-Benchmark/refs/heads/main/';

  // Define pairs: {container, wtFile, mutFile, wtResidue:{num,name}, mutResidue:{num,name}}
  const PAIRS = [
    {
      container: 'v1',
      wtFile: 'EGFR_erlotinib_trimmed.pdb',
      mutFile:'EGFR_erlotinib_T790W_trimmed.pdb',
      wtResidue: { num: 790, name: 'THR' },
      mutResidue:{ num: 790, name: 'TRP' },
      labelId: 'l1',
      playBtn: 'p1Play', resetBtn: 'p1Reset', recBtn: 'p1Rec'
    },
    {
      container: 'v2',
      wtFile: 'EGFR_osimertinib_trimmed.pdb',
      mutFile:'EGFR_osimertinib_C797F_trimmed.pdb',
      wtResidue: { num: 797, name: 'CYS' },
      mutResidue:{ num: 797, name: 'PHE' },
      labelId: 'l2',
      playBtn: 'p2Play', resetBtn: 'p2Reset', recBtn: 'p2Rec'
    }
  ];

  const $ = id => document.getElementById(id);

  async function fetchPDB(url){
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error(`${r.status} ${r.statusText} — ${url}`);
    return await r.text();
  }

  async function loadText(name){
    try { return await fetchPDB(LOCAL_BASE + name); }
    catch(e1){ try { return await fetchPDB(RAW_BASE + name); }
    catch(e2){ throw e2; } }
  }

  function addProteinAndLigand(viewer, pdbText){
    const m = viewer.addModel(pdbText, 'pdb');
    // styles are set later per model with opacities
    return m;
  }

  function setStylesForModels(viewer, mWT, mMut, alphaWT, alphaMut){
    // protein
    mWT.setStyle({hetflag:false}, {cartoon:{color:'spectrum', opacity:alphaWT}});
    mMut.setStyle({hetflag:false}, {cartoon:{color:'spectrum', opacity:alphaMut}});
    // ligand
    mWT.setStyle({hetflag:true},  {stick:{radius:0.22, opacity:alphaWT}});
    mMut.setStyle({hetflag:true},  {stick:{radius:0.22, opacity:alphaMut}});
  }

  function highlightResidueLabel(viewer, resid, name){
    // remove prior labels (simple approach)
    viewer.removeAllLabels();
    // find residue atoms (non-het)
    const atoms = viewer.getModel(0)?.selectedAtoms({hetflag:false, resi:resid}) || [];
    let pos = null;
    if(atoms.length){
      let cx=0,cy=0,cz=0; atoms.forEach(a=>{cx+=a.x;cy+=a.y;cz+=a.z}); pos={x:cx/atoms.length,y:cy/atoms.length,z:cz/atoms.length};
    }
    // fallback: use het centroid if no backbone found
    if(!pos){
      const la = viewer.getModel(0)?.selectedAtoms({hetflag:true}) || [];
      if(la.length){
        let cx=0,cy=0,cz=0; la.forEach(a=>{cx+=a.x;cy+=a.y;cz+=a.z}); pos={x:cx/la.length,y:cy/la.length,z:cz/la.length};
      } else {
        pos = {x:0,y:0,z:0};
      }
    }
    viewer.addLabel(`${name} ${resid}`, {
      position: pos,
      backgroundColor:"rgba(0,0,0,0.65)",
      backgroundOpacity:0.65,
      fontColor:"white",
      fontSize:14,
      borderThickness:0.0,
      alignment:"center"
    });
  }

  function animateCrossfade(viewer, mWT, mMut, opts){
    const {ms=3000, onStart, onUpdate, onEnd} = opts || {};
    let start = null, raf = null;
    if(onStart) onStart();

    function step(ts){
      if(!start) start = ts;
      const t = Math.min(1, (ts - start) / ms);
      const ease = 0.5 - 0.5 * Math.cos(Math.PI * t); // cosine ease
      const aWT = 1 - ease;
      const aMut = ease;
      setStylesForModels(viewer, mWT, mMut, aWT, aMut);
      viewer.render();
      if(onUpdate) onUpdate(t);
      if(t < 1){ raf = requestAnimationFrame(step); }
      else { if(onEnd) onEnd(); }
    }
    raf = requestAnimationFrame(step);
    return () => cancelAnimationFrame(raf);
  }

  function setLabelText(labelId, text){ $(labelId).textContent = text; }

  async function setupPair(pair){
    const el = $(pair.container);
    const viewer = $3Dmol.createViewer(el, {backgroundColor:'#0a0e1f'});
    // Load WT first for label positioning
    const wtText = await loadText(pair.wtFile);
    const mutText= await loadText(pair.mutFile);

    const mWT = addProteinAndLigand(viewer, wtText);
    const mMut = addProteinAndLigand(viewer, mutText);

    // Start with WT visible, mutant hidden
    setStylesForModels(viewer, mWT, mMut, 1, 0);

    // zoom around ligand if present; else whole
    const lig = mWT.selectedAtoms({hetflag:true});
    if(lig && lig.length) viewer.zoomTo({model:mWT, hetflag:true}); else viewer.zoomTo();
    viewer.render();

    // initial residue label (WT)
    highlightResidueLabel(viewer, pair.wtResidue.num, pair.wtResidue.name);
    setLabelText(pair.labelId, `${pair.wtResidue.name} ${pair.wtResidue.num}`);

    // Controls
    const playBtn = $(pair.playBtn), resetBtn = $(pair.resetBtn), recBtn = $(pair.recBtn);
    let cancelAnim = null;

    playBtn.onclick = () => {
      playBtn.disabled = true; resetBtn.disabled = true;
      // gentle camera drift to make it feel alive
      const spinOn = setInterval(()=>viewer.rotate(0.3), 16);

      cancelAnim = animateCrossfade(viewer, mWT, mMut, {
        ms: 3000,
        onStart: () => {},
        onUpdate: (t) => {
          // Midway: gently zoom a touch toward ligand
          if(t < 0.6 && lig && lig.length) viewer.zoom(1.002);
        },
        onEnd: () => {
          clearInterval(spinOn);
          // Update residue label to mutant at the end
          highlightResidueLabel(viewer, pair.mutResidue.num, pair.mutResidue.name);
          setLabelText(pair.labelId, `${pair.mutResidue.name} ${pair.mutResidue.num}`);
          playBtn.disabled = false; resetBtn.disabled = false;
        }
      });
    };

    resetBtn.onclick = () => {
      if(cancelAnim) cancelAnim();
      setStylesForModels(viewer, mWT, mMut, 1, 0);
      highlightResidueLabel(viewer, pair.wtResidue.num, pair.wtResidue.name);
      setLabelText(pair.labelId, `${pair.wtResidue.name} ${pair.wtResidue.num}`);
      viewer.zoomTo({model:mWT, hetflag:true}); viewer.render();
    };

    // ---- Recording (5s) ----
    recBtn.onclick = async () => {
      recBtn.disabled = true;
      try{
        // Find the canvas inside this viewer
        const canvas = el.querySelector('canvas');
        const stream = canvas.captureStream(30); // 30 fps
        const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
        const chunks = [];
        recorder.ondataavailable = e => { if(e.data.size) chunks.push(e.data); };
        recorder.onstop = () => {
          const blob = new Blob(chunks, {type:'video/webm'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = (pair.wtFile.replace('.pdb','') + '_to_' + pair.mutFile.replace('.pdb','') + '.webm').replace(/[^a-z0-9_\-\.]/gi,'_');
          a.click();
          URL.revokeObjectURL(a.href);
          recBtn.disabled = false;
        };
        recorder.start();

        // auto-play a transition while recording
        playBtn.click();

        // stop after 5s
        setTimeout(()=>recorder.stop(), 5000);
      } catch(e){
        alert('Recording not supported in this browser: ' + e.message);
        recBtn.disabled = false;
      }
    };
  }

  // Bootstrap both pairs
  (async ()=>{
    for(const p of PAIRS){
      try { await setupPair(p); }
      catch(e){
        const host = $(p.container).parentElement;
        const err = document.createElement('div');
        err.style.position='absolute'; err.style.inset='auto 12px 12px 12px';
        err.style.background='#fff2f2'; err.style.color='#8b0000'; err.style.padding='8px 10px'; err.style.borderRadius='8px';
        err.style.fontSize='12px'; err.style.border='1px solid #f3c2c2';
        err.innerHTML = `⚠️ Couldn’t load one or both PDBs for this panel.<br><code>${e.message}</code>`;
        host.appendChild(err);
      }
    }
  })();
</script>
</body>
</html>
