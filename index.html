<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EGFR — Mutation then Ligand Motion (WT → Mut)</title>
<script src="https://3dmol.org/build/3Dmol-min.js"></script>
<style>
  :root{--h:440px;--gap:14px}
  *{box-sizing:border-box}
  body{margin:0;background:#0b1020;color:#eaf2ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  header{padding:16px;background:linear-gradient(90deg,#203773,#5aa3ff);font-weight:800}
  header .sub{opacity:.9;font-weight:500;font-size:13.5px}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:var(--gap);grid-template-columns:1fr}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:linear-gradient(180deg,#121a33,#0f1530);border:1px solid rgba(138,162,255,.22);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
  .head{padding:12px 14px;border-bottom:1px solid rgba(138,162,255,.22);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .title{font-weight:750}
  .meta{opacity:.85;font-size:12.5px}
  .viewerWrap{position:relative;height:var(--h);background:#0a0e1f}
  .viewer{position:absolute;inset:0}
  .label{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.55);padding:6px 10px;border-radius:8px;font-size:12.5px}
  .hud{padding:10px 12px;border-top:1px solid rgba(138,162,255,.22);display:grid;gap:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid rgba(138,162,255,.35);background:rgba(90,163,255,.12);padding:8px 10px;border-radius:10px;color:#eaf2ff;font-weight:650;font-size:12.5px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .range{flex:1;appearance:none;height:6px;border-radius:999px;background:rgba(138,162,255,.25);outline:none}
  .range::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#5aa3ff;border:2px solid #fff;cursor:pointer}
  .small{font-size:12.5px;opacity:.85}
  .warn{color:#f59e0b}
</style>
</head>
<body>
<header>
  <div>EGFR — Mutation then Ligand Motion</div>
  <div class="sub">Phase 1: residue mutation appears. Phase 2: ligand atoms move from WT → Mutant coordinates. Protein stays fixed (WT/cartoon).</div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Pair 1: Erlotinib (WT vs T790W) -->
    <section class="card" id="pair1">
      <div class="head">
        <div>
          <div class="title">Erlotinib — WT → T790W</div>
          <div class="meta">Residue 790 then ligand motion</div>
        </div>
        <div class="small" id="p1Note"></div>
      </div>
      <div class="viewerWrap">
        <div id="v1" class="viewer"></div>
        <div class="label" id="l1">THR 790</div>
      </div>
      <div class="hud">
        <div class="row">
          <button class="btn" id="p1Play">▶ Play</button>
          <button class="btn" id="p1Pause" disabled>⏸ Pause</button>
          <button class="btn" id="p1Reset">↺ Reset</button>
          <input class="range" id="p1Range" type="range" min="0" max="100" value="0" />
          <span class="small" id="p1Pct">0%</span>
        </div>
      </div>
    </section>

    <!-- Pair 2: Osimertinib (WT vs C797F) -->
    <section class="card" id="pair2">
      <div class="head">
        <div>
          <div class="title">Osimertinib — WT → C797F</div>
          <div class="meta">Residue 797 then ligand motion</div>
        </div>
        <div class="small" id="p2Note"></div>
      </div>
      <div class="viewerWrap">
        <div id="v2" class="viewer"></div>
        <div class="label" id="l2">CYS 797</div>
      </div>
      <div class="hud">
        <div class="row">
          <button class="btn" id="p2Play">▶ Play</button>
          <button class="btn" id="p2Pause" disabled>⏸ Pause</button>
          <button class="btn" id="p2Reset">↺ Reset</button>
          <input class="range" id="p2Range" type="range" min="0" max="100" value="0" />
          <span class="small" id="p2Pct">0%</span>
        </div>
      </div>
    </section>

  </div>
  <p class="small" style="margin-top:10px;opacity:.8">
    If ligand atom lists differ, we fall back to a ligand crossfade and show a warning.
  </p>
</div>

<script>
  // ------------ FILES ------------
  const LOCAL_BASE = '';
  const RAW_BASE   = 'https://raw.githubusercontent.com/Mohammed-Balkhair-hub/Boltz-2_-Benchmark/refs/heads/main/';

  const PAIRS = [
    {
      container:'v1', noteId:'p1Note', rangeId:'p1Range', pctId:'p1Pct',
      playId:'p1Play', pauseId:'p1Pause', resetId:'p1Reset', labelId:'l1',
      wtFile:'EGFR_erlotinib_trimmed.pdb',
      mutFile:'EGFR_erlotinib_T790W_trimmed.pdb',
      resi:790, wtName:'THR', mutName:'TRP'
    },
    {
      container:'v2', noteId:'p2Note', rangeId:'p2Range', pctId:'p2Pct',
      playId:'p2Play', pauseId:'p2Pause', resetId:'p2Reset', labelId:'l2',
      wtFile:'EGFR_osimertinib_trimmed.pdb',
      mutFile:'EGFR_osimertinib_C797F_trimmed.pdb',
      resi:797, wtName:'CYS', mutName:'PHE'
    }
  ];

  const $ = id => document.getElementById(id);
  async function fetchPDB(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(`${r.status} ${r.statusText} — ${url}`); return r.text(); }
  async function loadText(name){ try{ return await fetchPDB(LOCAL_BASE+name); } catch(e1){ return await fetchPDB(RAW_BASE+name); } }

  function setProteinStyle(model){
    model.setStyle({hetflag:false},{cartoon:{color:'spectrum'}});
  }
  function styleResidue(model, resi, opacity, color){
    model.setStyle({hetflag:false, resi},{stick:{radius:0.35, opacity, color}});
  }
  function hideAllResidue(model, resi){
    model.setStyle({hetflag:false, resi},{});
  }
  function showLigand(model, opacity=1){
    model.setStyle({hetflag:true},{stick:{radius:0.22, opacity}});
  }
  function hideLigand(model){
    model.setStyle({hetflag:true},{});
  }
  function centroid(model, resi){
    const at = model.selectedAtoms({hetflag:false, resi});
    if(!at.length) return null;
    let x=0,y=0,z=0; at.forEach(a=>{x+=a.x;y+=a.y;z+=a.z});
    return {x:x/at.length, y:y/at.length, z:z/at.length};
  }
  function setResidueLabel(viewer, model, resi, name){
    viewer.removeAllLabels();
    const c = centroid(model, resi) || {x:0,y:0,z:0};
    viewer.addLabel(`${name} ${resi}`, {
      position:c, backgroundColor:"rgba(0,0,0,0.65)", backgroundOpacity:0.65,
      fontColor:"white", fontSize:14, borderThickness:0, alignment:"center"
    });
  }

  function buildLigandMorph(viewer, mWT, mMut){
    const ligWT = mWT.selectedAtoms({hetflag:true});
    const ligMut = mMut.selectedAtoms({hetflag:true});

    // Build a robust mapping by index; if counts mismatch => fallback
    if(ligWT.length !== ligMut.length){
      showLigand(mWT,1); showLigand(mMut,0);
      return {
        isFallback:true, a:0,
        scrub(a){ this.a=a; showLigand(mWT, 1-a); showLigand(mMut, a); viewer.render(); },
        reset(){ this.scrub(0); },
        play(){ let t0=null, raf=null, start=this.a, dur=2000*(1-start+1e-6);
          const step=ts=>{ if(!t0) t0=ts; const t=Math.min(1,(ts-t0)/dur); this.scrub(start+(1-start)*t); if(t<1) raf=requestAnimationFrame(step); };
          raf=requestAnimationFrame(step); this._raf=raf; },
        pause(){ if(this._raf) cancelAnimationFrame(this._raf); }
      };
    }

    // Coordinate tween
    showLigand(mWT,1);
    hideLigand(mMut);

    const map = ligWT.map((a,i)=>({wt:a, mut:ligMut[i]}));
    // Save original WT coords
    map.forEach(({wt})=>{ wt._x0=wt.x; wt._y0=wt.y; wt._z0=wt.z; });

    function apply(a){
      for(const {wt,mut} of map){
        wt.x = wt._x0 + a*(mut.x - wt._x0);
        wt.y = wt._y0 + a*(mut.y - wt._y0);
        wt.z = wt._z0 + a*(mut.z - wt._z0);
      }
      // Force 3Dmol to rebuild sticks this frame (critical for visible motion)
      mWT.setStyle({hetflag:true},{stick:{radius:0.22}});
      viewer.render();
    }

    return {
      isFallback:false, a:0,
      scrub(a){ this.a=a; apply(a); },
      reset(){ this.a=0; apply(0); },
      play(){ let t0=null, raf=null, start=this.a, dur=2000*(1-start+1e-6);
        const step=ts=>{ if(!t0) t0=ts; const t=Math.min(1,(ts-t0)/dur); const a=start+(1-start)*t; this.scrub(a); if(t<1) raf=requestAnimationFrame(step); };
        raf=requestAnimationFrame(step); this._raf=raf; },
      pause(){ if(this._raf) cancelAnimationFrame(this._raf); }
    };
  }

  async function setupPair(cfg){
    const el = $(cfg.container);
    const viewer = $3Dmol.createViewer(el, {backgroundColor:'#0a0e1f'});

    // Load structures
    const [wtText, mutText] = await Promise.all([loadText(cfg.wtFile), loadText(cfg.mutFile)]);
    const mWT  = viewer.addModel(wtText,  'pdb');
    const mMut = viewer.addModel(mutText, 'pdb');

    // Protein (WT) as context
    setProteinStyle(mWT);
    setProteinStyle(mMut); // but we won't show mutant except at residue
    hideLigand(mMut);
    showLigand(mWT,1);

    // Camera
    const ligWT = mWT.selectedAtoms({hetflag:true});
    if(ligWT && ligWT.length) viewer.zoomTo({model:mWT, hetflag:true}); else viewer.zoomTo();
    viewer.render();

    // Initial residue label
    setResidueLabel(viewer, mWT, cfg.resi, cfg.wtName);
    $(cfg.labelId).textContent = `${cfg.wtName} ${cfg.resi}`;

    // Residue morph controller (opacity blend for just that residue)
    let residueAlpha = 0;
    function residueApply(a){
      // WT residue fades out, Mut residue fades in
      styleResidue(mWT, cfg.resi, 1-a, 'yellow');
      styleResidue(mMut, cfg.resi, a,   'yellow');
      viewer.render();
    }
    // start with WT residue emphasized
    residueApply(0);

    // Ligand morph (phase 2)
    const morph = buildLigandMorph(viewer, mWT, mMut);
    if(morph.isFallback) $(cfg.noteId).innerHTML = '<span class="warn">Ligand atoms differ — using crossfade for ligand.</span>';

    // Scrubber (maps 0..100 to two phases: 0..33% = residue; 33..100% = ligand)
    const range=$(cfg.rangeId), pct=$(cfg.pctId);
    function setScrub(v){
      const p = Math.max(0, Math.min(100, Number(v)));
      pct.textContent = `${p}%`;

      const t = p/100;
      if(t <= 1/3){
        const a = t * 3;         // 0..1 over first 1/3
        residueAlpha = a;
        residueApply(a);
        morph.scrub(0);
        setResidueLabel(viewer, mWT, cfg.resi, a<0.999 ? cfg.wtName : cfg.mutName);
        $(cfg.labelId).textContent = `${a<0.999 ? cfg.wtName : cfg.mutName} ${cfg.resi}`;
      } else {
        residueApply(1);         // residue fully mutated
        const a = (t - 1/3) * 1.5; // map 1/3..1 to 0..1
        morph.scrub(Math.max(0, Math.min(1, a)));
        setResidueLabel(viewer, mWT, cfg.resi, cfg.mutName);
        $(cfg.labelId).textContent = `${cfg.mutName} ${cfg.resi}`;
      }
    }
    range.oninput = e => setScrub(e.target.value);
    setScrub(0);

    // Play/Pause/Reset
    const playBtn=$(cfg.playId), pauseBtn=$(cfg.pauseId), resetBtn=$(cfg.resetId);
    let raf=null, tHold=0; // t in [0..1]

    function cancel(){ if(raf) cancelAnimationFrame(raf); raf=null; }

    function playFromCurrent(){
      playBtn.disabled = true; pauseBtn.disabled = false;
      const start = tHold;
      const dur = 3000 * (1 - start + 1e-6);
      let t0=null;

      function step(ts){
        if(!t0) t0=ts;
        tHold = Math.min(1, (ts - t0)/dur + start);
        range.value = Math.round(tHold*100);
        setScrub(range.value);
        if(tHold < 1) raf = requestAnimationFrame(step);
        else { playBtn.disabled=false; pauseBtn.disabled=true; cancel(); }
      }
      raf = requestAnimationFrame(step);
    }

    playBtn.onclick = () => playFromCurrent();
    pauseBtn.onclick = () => { cancel(); pauseBtn.disabled=true; playBtn.disabled=false; };
    resetBtn.onclick = () => {
      cancel();
      tHold = 0; range.value = 0; setScrub(0);
      pauseBtn.disabled = true; playBtn.disabled = false;
      // re-zoom consistently (no drift)
      if(ligWT && ligWT.length) viewer.zoomTo({model:mWT, hetflag:true}); else viewer.zoomTo();
      viewer.render();
    };

    // Keep absolutely still
    if (viewer.spin) viewer.spin(false);
  }

  (async()=>{
    for(const p of PAIRS){
      try{ await setupPair(p); }
      catch(e){
        const host = $(p.container).parentElement;
        const err = document.createElement('div');
        err.style.position='absolute'; err.style.inset='auto 12px 12px 12px';
        err.style.background='#fff2f2'; err.style.color='#8b0000'; err.style.padding='8px 10px';
        err.style.borderRadius='8px'; err.style.fontSize='12px'; err.style.border='1px solid #f3c2c2';
        err.innerHTML = `⚠️ Couldn’t load one or both PDBs for this panel.<br><code>${e.message}</code>`;
        host.appendChild(err);
      }
    }
  })();
</script>
</body>
</html>
