<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EGFR — Drug Motion WT → Mutant</title>
<script src="https://3dmol.org/build/3Dmol-min.js"></script>
<style>
  :root{--h:440px;--gap:14px}
  *{box-sizing:border-box}
  body{margin:0;background:#0b1020;color:#eaf2ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  header{padding:16px;background:linear-gradient(90deg,#203773,#5aa3ff);font-weight:800}
  header .sub{opacity:.9;font-weight:500;font-size:13.5px}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:var(--gap);grid-template-columns:1fr}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:linear-gradient(180deg,#121a33,#0f1530);border:1px solid rgba(138,162,255,.22);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
  .head{padding:12px 14px;border-bottom:1px solid rgba(138,162,255,.22);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .title{font-weight:750}
  .meta{opacity:.85;font-size:12.5px}
  .viewerWrap{position:relative;height:var(--h);background:#0a0e1f}
  .viewer{position:absolute;inset:0}
  .label{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.55);padding:6px 10px;border-radius:8px;font-size:12.5px}
  .hud{padding:10px 12px;border-top:1px solid rgba(138,162,255,.22);display:grid;gap:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid rgba(138,162,255,.35);background:rgba(90,163,255,.12);padding:8px 10px;border-radius:10px;color:#eaf2ff;font-weight:650;font-size:12.5px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .range{flex:1;appearance:none;height:6px;border-radius:999px;background:rgba(138,162,255,.25);outline:none}
  .range::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:#5aa3ff;border:2px solid #fff;cursor:pointer}
  .small{font-size:12.5px;opacity:.85}
  .warn{color:#f59e0b}
</style>
</head>
<body>
<header>
  <div>EGFR — Drug Motion WT → Mutant</div>
  <div class="sub">Protein stays fixed. Ligand atoms are morphed from WT coordinates to mutant coordinates so you can SEE the motion.</div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- Pair 1: Erlotinib (WT vs T790W) -->
    <section class="card" id="pair1">
      <div class="head">
        <div>
          <div class="title">Erlotinib — WT → T790W</div>
          <div class="meta">Residue 790 highlighted; ligand trajectory is interpolated</div>
        </div>
        <div class="small" id="p1Note"></div>
      </div>
      <div class="viewerWrap">
        <div id="v1" class="viewer"></div>
        <div class="label" id="l1">THR 790</div>
      </div>
      <div class="hud">
        <div class="row">
          <button class="btn" id="p1Play">▶ Play</button>
          <button class="btn" id="p1Pause" disabled>⏸ Pause</button>
          <button class="btn" id="p1Reset">↺ Reset</button>
          <input class="range" id="p1Range" type="range" min="0" max="100" value="0" />
          <span class="small" id="p1Pct">0%</span>
        </div>
      </div>
    </section>

    <!-- Pair 2: Osimertinib (WT vs C797F) -->
    <section class="card" id="pair2">
      <div class="head">
        <div>
          <div class="title">Osimertinib — WT → C797F</div>
          <div class="meta">Residue 797 highlighted; ligand trajectory is interpolated</div>
        </div>
        <div class="small" id="p2Note"></div>
      </div>
      <div class="viewerWrap">
        <div id="v2" class="viewer"></div>
        <div class="label" id="l2">CYS 797</div>
      </div>
      <div class="hud">
        <div class="row">
          <button class="btn" id="p2Play">▶ Play</button>
          <button class="btn" id="p2Pause" disabled>⏸ Pause</button>
          <button class="btn" id="p2Reset">↺ Reset</button>
          <input class="range" id="p2Range" type="range" min="0" max="100" value="0" />
          <span class="small" id="p2Pct">0%</span>
        </div>
      </div>
    </section>

  </div>
  <p class="small" style="margin-top:10px;opacity:.8">
    If ligand atom counts/order differ between WT and mutant, the code falls back to opacity crossfade and shows a warning.
  </p>
</div>

<script>
  // ------------ FILES ------------
  const LOCAL_BASE = '';
  const RAW_BASE   = 'https://raw.githubusercontent.com/Mohammed-Balkhair-hub/Boltz-2_-Benchmark/refs/heads/main/';

  const PAIRS = [
    {
      container:'v1', noteId:'p1Note', rangeId:'p1Range', pctId:'p1Pct',
      playId:'p1Play', pauseId:'p1Pause', resetId:'p1Reset', labelId:'l1',
      wtFile:'EGFR_erlotinib_trimmed.pdb',
      mutFile:'EGFR_erlotinib_T790W_trimmed.pdb',
      resi:790, wtName:'THR', mutName:'TRP'
    },
    {
      container:'v2', noteId:'p2Note', rangeId:'p2Range', pctId:'p2Pct',
      playId:'p2Play', pauseId:'p2Pause', resetId:'p2Reset', labelId:'l2',
      wtFile:'EGFR_osimertinib_trimmed.pdb',
      mutFile:'EGFR_osimertinib_C797F_trimmed.pdb',
      resi:797, wtName:'CYS', mutName:'PHE'
    }
  ];

  const $ = id => document.getElementById(id);
  async function fetchPDB(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(`${r.status} ${r.statusText} — ${url}`); return r.text(); }
  async function loadText(name){ try{ return await fetchPDB(LOCAL_BASE+name); } catch(e1){ return await fetchPDB(RAW_BASE+name); } }

  function setProteinStyle(model){
    model.setStyle({hetflag:false},{cartoon:{color:'spectrum'}});
  }
  function hideLigand(model){
    model.setStyle({hetflag:true},{});
  }
  function showLigand(model){
    model.setStyle({hetflag:true},{stick:{radius:0.22}});
  }

  function centroid(model, resi){
    const at = model.selectedAtoms({hetflag:false, resi});
    if(!at.length) return null;
    let x=0,y=0,z=0; at.forEach(a=>{x+=a.x;y+=a.y;z+=a.z});
    return {x:x/at.length, y:y/at.length, z:z/at.length};
  }
  function setResidueLabel(viewer, model, resi, name){
    viewer.removeAllLabels();
    const c = centroid(model, resi) || {x:0,y:0,z:0};
    viewer.addLabel(`${name} ${resi}`, {
      position:c, backgroundColor:"rgba(0,0,0,0.65)", backgroundOpacity:0.65,
      fontColor:"white", fontSize:14, borderThickness:0, alignment:"center"
    });
  }

  // Build a ligand morph controller. Returns {scrub(a), play(), pause(), reset(), isFallback}
  function buildLigandMorph(viewer, mWT, mMut){
    // collect ligand atoms (hetflag=true) from BOTH models
    const ligWT = mWT.selectedAtoms({hetflag:true});
    const ligMut = mMut.selectedAtoms({hetflag:true});

    // If counts mismatch, we can't 1:1 map atoms → fallback to crossfade
    if(ligWT.length !== ligMut.length){
      // show both ligands, then interpolate opacity instead of coordinates
      let alpha = 0; // 0=WT only, 1=Mut only
      showLigand(mWT); showLigand(mMut);
      return {
        isFallback: true,
        scrub(a){
          alpha = Math.max(0, Math.min(1,a));
          mWT.setStyle({hetflag:true},{stick:{radius:0.22, opacity:1-alpha}});
          mMut.setStyle({hetflag:true},{stick:{radius:0.22, opacity:alpha}});
          viewer.render();
        },
        play(){ let t0=null, raf=null; const dur=3000*(1-this._a||1);
          const step=ts=>{ if(!t0) t0=ts; const t=Math.min(1,(ts-t0)/dur); this.scrub((this._a??0)+(1-(this._a??0))*t); if(t<1) raf=requestAnimationFrame(step); };
          raf=requestAnimationFrame(step); this._raf=raf;
        },
        pause(){ if(this._raf) cancelAnimationFrame(this._raf); this._raf=null; this._a=this._a ?? 0; },
        reset(){ this._a=0; this.scrub(0); }
      };
    }

    // Coordinate tween: update WT ligand atom coords toward mutant coords
    showLigand(mWT);
    hideLigand(mMut); // keep mutant hidden; we only read its coords

    // Build a simple 1:1 mapping by index (assumes same atom order)
    const map = ligWT.map((a,i)=>({wt:a, mut:ligMut[i]}));
    let aHold = 0, rafId = null;

    function apply(a){
      aHold = a;
      for(const {wt,mut} of map){
        wt.x = wt._x0 + a*(mut.x - wt._x0);
        wt.y = wt._y0 + a*(mut.y - wt._y0);
        wt.z = wt._z0 + a*(mut.z - wt._z0);
      }
      viewer.render();
    }
    // store initial WT coords once
    for(const {wt} of map){ wt._x0 = wt.x; wt._y0 = wt.y; wt._z0 = wt.z; }

    return {
      isFallback:false,
      scrub(a){ a=Math.max(0,Math.min(1,a)); apply(a); },
      play(){
        let t0=null; const start=aHold; const dur=3000*(1-start+1e-6);
        const step=(ts)=>{ if(!t0) t0=ts; const t=Math.min(1,(ts-t0)/dur); const a=start+(1-start)*t; apply(a); if(t<1) rafId=requestAnimationFrame(step); };
        rafId=requestAnimationFrame(step);
      },
      pause(){ if(rafId) cancelAnimationFrame(rafId); rafId=null; },
      reset(){
        // reset ligand to stored WT coords
        for(const {wt} of map){ wt.x=wt._x0; wt.y=wt._y0; wt.z=wt._z0; }
        aHold=0; viewer.render();
      }
    };
  }

  async function setupPair(cfg){
    const el = $(cfg.container);
    const viewer = $3Dmol.createViewer(el, {backgroundColor:'#0a0e1f'});

    // Load both structures
    const [wtText, mutText] = await Promise.all([loadText(cfg.wtFile), loadText(cfg.mutFile)]);
    const mWT  = viewer.addModel(wtText,  'pdb');
    const mMut = viewer.addModel(mutText, 'pdb');

    // Protein fixed as WT
    setProteinStyle(mWT);
    hideLigand(mWT); // we’ll show ligand via the morph controller
    setProteinStyle(mMut);
    hideLigand(mMut); // never show mutant protein (just reading its ligand coords)

    // Now add a SEPARATE copy of WT to display protein+ligand together:
    // Actually re-show WT ligand so it’s visible and moveable:
    showLigand(mWT);

    // Camera: zoom around WT ligand if present
    const ligAtomsWT = mWT.selectedAtoms({hetflag:true});
    if(ligAtomsWT && ligAtomsWT.length) viewer.zoomTo({model:mWT, hetflag:true}); else viewer.zoomTo();
    viewer.render();

    // Labels
    setResidueLabel(viewer, mWT, cfg.resi, cfg.wtName);
    $(cfg.labelId).textContent = `${cfg.wtName} ${cfg.resi}`;

    // Morph controller
    const morph = buildLigandMorph(viewer, mWT, mMut);
    if(morph.isFallback) $(cfg.noteId).innerHTML = '<span class="warn">Ligand atom lists differ — using crossfade fallback.</span>';

    // Controls
    const range=$(cfg.rangeId), pct=$(cfg.pctId);
    const playBtn=$(cfg.playId), pauseBtn=$(cfg.pauseId), resetBtn=$(cfg.resetId);

    function setAlpha(v){
      const a = Number(v)/100;
      pct.textContent = `${Math.round(a*100)}%`;
      morph.scrub(a);
      if(a<0.999){ setResidueLabel(viewer, mWT, cfg.resi, cfg.wtName); $(cfg.labelId).textContent = `${cfg.wtName} ${cfg.resi}`; }
      else{ setResidueLabel(viewer, mWT, cfg.resi, cfg.mutName); $(cfg.labelId).textContent = `${cfg.mutName} ${cfg.resi}`; }
    }
    range.oninput = e => setAlpha(e.target.value);
    setAlpha(0);

    playBtn.onclick = ()=>{
      playBtn.disabled=true; pauseBtn.disabled=false;
      morph.play();
      // enable pause after starting
      setTimeout(()=>pauseBtn.disabled=false, 50);
    };
    pauseBtn.onclick = ()=>{
      morph.pause();
      pauseBtn.disabled=true; playBtn.disabled=false;
    };
    resetBtn.onclick = ()=>{
      morph.pause?.(); morph.reset();
      range.value=0; setAlpha(0);
      pauseBtn.disabled=true; playBtn.disabled=false;
      // keep camera fixed
      if(ligAtomsWT && ligAtomsWT.length) viewer.zoomTo({model:mWT, hetflag:true}); else viewer.zoomTo();
      viewer.render();
    };

    if (viewer.spin) viewer.spin(false); // absolutely no camera drift
  }

  (async()=>{
    for(const p of PAIRS){
      try{ await setupPair(p); }
      catch(e){
        const host = $(p.container).parentElement;
        const err = document.createElement('div');
        err.style.position='absolute'; err.style.inset='auto 12px 12px 12px';
        err.style.background='#fff2f2'; err.style.color='#8b0000'; err.style.padding='8px 10px';
        err.style.borderRadius='8px'; err.style.fontSize='12px'; err.style.border='1px solid #f3c2c2';
        err.innerHTML = `⚠️ Couldn’t load one or both PDBs for this panel.<br><code>${e.message}</code>`;
        host.appendChild(err);
      }
    }
  })();
</script>
</body>
</html>
